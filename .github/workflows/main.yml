name: Gerenciar Infraestrutura (Terraform AKS)

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Escolha a aÃ§Ã£o'
        required: true
        default: 'deploy'
        type: choice
        options:
        - deploy
        - destroy

permissions:
  id-token: write
  contents: read

# ConfiguraÃ§Ã£o de ambiente para o Terraform autenticar
env:
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  # Se vocÃª usou o JSON Ãºnico no secret AZURE_CREDENTIALS, o azure/login lida com isso,
  # mas o Terraform precisa das variÃ¡veis acima ou de uma configuraÃ§Ã£o especÃ­fica.
  # Para simplificar hoje, vamos confiar no azure/login gerando o arquivo de credenciais.

jobs:
  # ==============================================================================
  # JOB 1: VALIDAR (Roda sempre que nÃ£o for Destroy)
  # ==============================================================================
  validate:
    if: ${{ github.event.inputs.action == 'deploy' }}
    name: ðŸ”Ž Validar CÃ³digo
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Login no Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Terraform Plan
        working-directory: ./infra
        run: |
          terraform init
          terraform validate
          terraform plan -var="vm_size=Standard_D2s_v3" -out=tfplan

  # ==============================================================================
  # JOB 2: DEPLOY (Roda se Validar passar)
  # ==============================================================================
  deploy:
    if: ${{ github.event.inputs.action == 'deploy' }}
    name: ðŸš€ Aplicar Infraestrutura
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Login no Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Terraform Apply
        working-directory: ./infra
        run: |
          terraform init
          # Usa o plano gerado na etapa anterior (idealmente usaria artifacts, mas aqui simplificamos)
          terraform apply -auto-approve -var="vm_size=Standard_D2s_v3"

  # ==============================================================================
  # JOB 3: PÃ“S-TESTES (Verifica se o Cluster estÃ¡ vivo)
  # ==============================================================================
  post-tests:
    if: ${{ github.event.inputs.action == 'deploy' }}
    name: âœ… Testar ConexÃ£o AKS
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Login no Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configurar Kubectl
        run: |
          # Baixa as credenciais do cluster recÃ©m-criado para testar
          az aks get-credentials --resource-group rg-ecommerce-michelotti --name aks-cluster-michelotti --overwrite-existing

      - name: Verificar Nodes
        run: |
          echo "Verificando se os nÃ³s estÃ£o prontos..."
          kubectl get nodes

  # ==============================================================================
  # JOB 4: DESTRUIR (SÃ³ roda se vocÃª selecionar 'destroy' no input)
  # ==============================================================================
  destroy:
    if: ${{ github.event.inputs.action == 'destroy' }}
    name: ðŸ§¨ Destruir Tudo
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Login no Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Terraform Destroy
        working-directory: ./infra
        run: |
          terraform init
          terraform destroy -auto-approve -var="vm_size=Standard_D2s_v3"